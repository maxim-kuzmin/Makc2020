# Серверное веб-приложение Makc2020.Apps.IdentityServer.Web

Реализовано на .NET Core 3.x, C#, Entity Framework, MS SQL Server.

Предоставляет HTTP REST API для аутентификации с помощью библиотеки
[IdentityServer4](http://docs.identityserver.io/en/latest/index.html)
по технологии [Single Sign-On](https://ru.wikipedia.org/wiki/Технология_единого_входа).

## База данных

Описание настроек доступа к базе данных, а также инструкции
по её созданию и обновлению можно увидеть [здесь](../Makc2020.Data.Entity.Clients.SqlServer/README.md).

## Настройка приложения

1. В папке **/Makc2020.Apps.IdentityServer.Web/ConfigFiles/** открыть один из файлов:

- **App.config.json**, если необходимо указать настройки для любого компьютера;

- **App.config.m.<Имя компьютера в верхнем регистре>.json**, если необходимо указать настройки только для компьтера с определённым именем.

2. В разделе **Logging:LogLevel:Default** указать уровень логирования по-умолчанию.

**Пример:**

    {  
      "Logging": {
        "IncludeScopes": false,
        "LogLevel": {
          "Default": "Warning"
        }
      },
      "AllowedHosts": "*"
    }

## Настройка хоста

Описание настроек хоста можно увидеть [здесь](../Makc2020.Host/README.md).

## Настройка мода "IdentityServer"

Описание настроек мода "IdentityServer" можно увидеть [здесь](../Makc2020.Mods.IdentityServer/README.md).

## Развёртывание

1. Если это не было сделано ранее, подготовить компьютер, на котором будет развёрнуто приложение:

- установить последнюю версию [Hosting Bundle](https://dotnet.microsoft.com/download/dotnet-core/3.1) для .NET Core;

- установить в локальное хранилище сертификат **develop sert(pwd-asdf).pfx**, файл
которого размещён в папке **/_info/deploy/**.
Для этого нужно сделать двойной клик по файлу сертификата и следовать указаниям мастера установки.
Когда мастер установки попросит указать хранилище, выбрать локальное.
Когда мастер установки попросит указать пароль, ввести: asdf.

2. Если это не было сделано ранее, подготовить компьютер, на котором будет собрано и опубликовано приложение, установив на нём
последнюю версию [SDK](https://dotnet.microsoft.com/download/dotnet-core/3.1) для .NET Core.

3. Открыть консоль и перейти в папку приложения:

       cd Makc2020.Apps.IdentityServer.Web

4. Собрать и опубликовать приложение, выполнив одну из команд:
 
- для продуктовой среды:

      dotnet publish Makc2020.Apps.IdentityServer.Web.csproj -c Release

- для тестовой среды:

      dotnet publish Makc2020.Apps.IdentityServer.Web.csproj -c Test

- для среды разработки:

      dotnet publish Makc2020.Apps.IdentityServer.Web.csproj -c Debug

5. Перейти в папку с файлами, предназначенными для публикации:
 
- для продуктовой среды:

      cd Makc2020.Apps.IdentityServer.Web/bin/Release/netcoreapp3.1/publish

- для тестовой среды:

      cd Makc2020.Apps.IdentityServer.Web/bin/Test/netcoreapp3.1/publish

- для среды разработки:

      cd Makc2020.Apps.IdentityServer.Web/bin/Debug/netcoreapp3.1/publish

6. Скопировать всё содержимое папки с файлами, предназначенными для публикации,
в папку компьютера, на котором должно быть развёрнуто приложение.

7. Настроить веб-сервер на обслуживание папки, в которой развёрнуто приложение.

## Пример настройки веб-сервера IIS, втроенного в операционную систему Windows

1. Если строка подключения к базе данных в файле Data.Entity.Clients.SqlServer.config.json, размещённом в папке
ConfigFiles, содержит настройку "Integrated Security=True", то в операционной системе Windows нужно
создать пользователя, предназначенного для доступа к базе данных. Этому пользователю нужно дать в базе
данных приложения права на чтение, запись и изменение структуры так, чтобы при запуске приложения от имени
этого пользователя база данных могла быть создана в случае её отсутствия и наполнена начальными данными.  

2. Открыть программу Internet Information services (IIS) Manager.

3. Создать пул приложений со следующими основными настройками:

- *Версия среды CLR .NET* (*.NET CLR version*): **Без управляемого кода** (**No managed Code**);

- *Режим управляемого конвейера* (*Managed pipeline mode*): **Встроенный** (**Integrated**).

4. Если были выполнены действия, перечисленные в пункте 1, то нужно открыть дополнительные настройки
пула приложений, созданного в пункте 3. Далее для настройки *Process Model / Identity* установить значение,
соответствующее имени пользователя, созданного в пункте 1.

5. Создать сайт со следующими основными настройками:

- *Пул приложений* (*Application pool*): **Имя пула приложений, созданного в пункте 3**;

- *Физический путь* (*Physical path*): **Путь к папке, в которой развёрнуто приложение**.

6. Для сайта, созданного в пункте 5, включить следующие настройки проверки подлинности: Анонимная и Windows.

# Библиотека классов Makc2020.Mods.IdentityServer.Base

Библиотека классов, предназначенная для реализации базовой функциональности мода "IdentityServer" -
сервера идентичности с помощью библиотеки [IdentityServer4](http://docs.identityserver.io/en/latest/index.html).

## Настройка

1. Открыть файл **Makc2020.Mods.IdentityServer/ConfigFiles/Mod.IdentityServer.Base.config.json**.

2. В разделе **ApiResources** указать список аутентифицируемых ресурсов API.
    Описание настроек для каждого ресурса API смотреть здесь:
    https://identityserver4.readthedocs.io/en/latest/reference/api_resource.html

3. В разделе **Clients** указать список аутентифицируемых клиентов.
    Описание настроек для каждого клиента смотреть здесь:
    https://identityserver4.readthedocs.io/en/latest/reference/client.html

4. В разделе **IdentityResources** указать список аутентифицируемых ресурсов идентичности.
    Описание вариантов ресурсов идентичности смотреть здесь:
    https://identityserver4.readthedocs.io/en/latest/reference/identity_resource.html

5. В разделе **DbCommandTimeout** указать таймаут выполнения команды запроса к базе данных в секундах.
Если будет указано значение **0**, таймаут будет установлен в 3600 секунд.

6. В разделе **Certificate** указать имя сертификата, который будет использоваться при подписывании
и валидации токена безопасности. Сертификат должен размещаться в локальном хранилище компьютера.

**Пример**

    {
      "ApiResources": [
        {
          "DisplayName": "Makc2020 web API",
          "Name": "Makc2020WebApi"
        }
      ],
      "Clients": [
        {
          "AllowedCorsOrigins": [
            "http://localhost:4201"

          ],
          "AllowedGrantTypes": "Implicit",
          "AllowOfflineAccess": true,
          "AllowedScopes": [
            "offline_access",
            "openid",
            "Makc2020WebApi"
          ],
          "ClientId": "Makc2020WebClient",
          "ClientName": "Makc2020 web client",
          "RequireClientSecret": false,
          "RequireConsent": false,
          "RequirePkce": false,
          "AllowAccessTokensViaBrowser": true,
          "ResponseMode": "fragment",
          "RedirectUris": [
            "http://localhost:4201/mods/auth/redirect"
          ],
          "PostLogoutRedirectUris": [
            "http://localhost:4201/mods/auth/redirect"
          ]
        }
      ],
      "IdentityResources": [
        "OpenId"
      ],
      "DbCommandTimeout": 0,
      "Certificate": "CN=Makc2020.IdentityServer"
    }

## Сертификат

Для создания самоподписанного сертификата и одновременного его размещения в локальном хранилище компьютера можно использовать команду:

    makecert -r -pe -n "CN=Makc2020.IdentityServer" -b 01/01/2000 -e 01/01/2036 -eku 1.3.6.1.5.5.7.3.1,1.3.6.1.5.5.7.3.2 -ss my -sr localMachine -sky exchange -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12 -len 2048

    где:

    "CN=Makc2020.IdentityServer" - имя сертификата,
    01/01/2000 - дата начала действия сертификата,
    01/01/2036 - дата окончания действия сертификата,
    1.3.6.1.5.5.7.3.1 - Назначение: Проверка подлинности сервера,
    1.3.6.1.5.5.7.3.2 - Назначение: Проверка подлинности клиента,
    localMachine - Местоположение: локальное хранилище.

Для сохранения размещённого в локальном хранилище сертификата в файле с расширением .pfx нужно:

1. Открыть консоль и перейти в папку, предназначенную для сохранения файла (допустим, это будет папка C:\cert):

        cd C:\cert

2. Запустить программу "Консоль управления", выполнив команду:

        mmc

3. Нажать CTRL+M, выбрать в появившемся диалоговом окне оснастку "Сертификаты", нажать на кнопку "Добавить":

- из предложенных вариантов выбрать последний - "учётной записи компьютера", нажать на кнопку "Далее";

- из предложенных вариантов выбрать первый - "локальным компьютером", нажать на кнопку "Готово".

4. Нажать на кнопку "OK".

5. В появившемся слева узле дерева "Сертификаты" выбрать узел "Личное - Сертификаты".

6. В появившемся справа списке сертификатов выбрать нужный и сделать по нему двойной клик.

7. В появившемся диалоговом окне выбрать вторую вкладку - "Состав".

8. Нажать на кнопку "Копировать в файл".

9. Нажимать на кнопки "Далее" до появления окна "Экспортирование закрытого ключа".

10. Из предложенных вариантов выбрать первый - "Да, экспортировать закрытый ключ" и нажать на кнопку "Далее".

11. На следующем окне оставить всё по-умолчанию и нажать на кнопку "Далее".

12. В появившемся окне "Безопасность" установить пароль, указать алгоритм шифрования "AES256-SHA256"
 и нажать на кнопку "Далее".

13. В появившемся окне указать имя файла и нажать на кнопку "Далее".

14. В появившемся окне нажать на кнопку "Готово".

Файл сертификата с указанным именем и расширением .pfx будет сохранён в выбранной на первом шаге папке.